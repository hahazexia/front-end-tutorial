# 互联网如何工作？

> 互联网是一个使用互联网协议族（TCP/IP）来连接全球范围内数以十亿计的设备而组成的一个相互连接的计算机网络系统。这个网络由数百万的私人的，公共的，学术的，企业的，政府的网络构成，通过电子的，无线的和光纤网络技术实现连接。它承载了巨大的信息数据和服务，例如相互链接的超文本文档和万维网应用，电子邮件，电话服务和点对点文件传输。[以上解释引用自维基百科](https://en.wikipedia.org/wiki/Internet)

## 引言

互联网是如何工作的？这个问题问得好。互联网的增长已经呈现爆炸式增长的趋势，它随处可见。正因为它已经成为了生活的一部分，所以我们才需要更好的理解它工作的原理以便更好的使用。

本篇文章就来解释通过什么基础设备和技术使得互联网可以运行。对于一些技术问题不会太深入，但是足以覆盖每一个点给出一个涉及到相关概念的基础解释。

## 从地址开始

因为互联网是全球的计算机互相连接，所以每一台连接到互联网的电脑必须有一个唯一的地址。互联网地址的格式为`xxx.xxx.xxx.xxx`，其中`xxx`是一个 0 到 255 的数字。这个地址被称为 IP 地址。（IP 代表了互联网协议；稍后详述）

下面的图片举例说明了两台连接了互联网的电脑；一台电脑 IP 地址是 1.2.3.4，另外一台是 5.6.7.8。而互联网在图中被表示成一个抽象的物体在两台电脑中间。（随着本文后续的讲解，下面这个图1会被提起多次直到互联网的细节被说明）

<p align="center">
  <img alt="internet" src="../img/internet1.gif">
</p>

如果你是通过互联网服务提供商（ISP）连接的网络，通常你会被指定一个临时的 IP 地址为了你在接入网络的这一段时间使用。如果你通过局域网（LAN）连接至网络，那么你的电脑可能会有一个不变的 IP 地址或者通过动态主机配置协议获取一个临时 IP 地址。无论如何，如果你连接了互联网，你的电脑就会拥有一个唯一的 IP 地址。

#### **了解一下：`ping`命令**

如果你正在使用微软系统或者一种 Unix 系统，并且连接了网络，系统中有一个方便的程序用来查看当前的网络连接是正常的。这个命令叫做 **ping**，也许这个名字与旧式潜艇声纳系统的声音有关。如果你的系统是 windows，先打开一个命令提示符窗口。如果你使用的是类 Unix 系统，同样到命令提示符中。输入`ping www.baidu.com`。ping 命令会发送一个'ping'（实际上是一个 ICMP 回声请求信息，也就是因特网控制消息协议的请求信息）到指定名字的电脑。被 ping 的电脑会对你的信息作出响应。ping 程序会计算从消息发出到接收到响应一共花费了多少时间（如果接受到了目标电脑的响应）。同样，如果你输入的是一个域名而不是一个 IP 地址，ping 命令会将域名解析为 IP 地址。稍后再来讲解域名和地址解决方案。

<p align="center">
  <img alt="internet" src="../img/ping.gif">
</p>

## 协议栈和数据包

你的电脑现在已经连接到了网络并且拥有了唯一的地址。但是它如何才能和其他同样联网的电脑交流呢？下面有这样一个例子：假设你的 IP 地址是 1.2.3.4，现在你想向电脑 5.6.7.8 的一台电脑发送一个信息。这条信息的内容是“Hello computer 5.6.7.8!”。很明显，这条信息必然会经过网线从你的电脑传送至网络。假设你现在已经接入了当地的互联网服务提供商（例如，联通，电信），那么信息文本一定会先被翻译成电子信号，经过网络的传送后，电子信号再被重新转变回原来的文本信息。这个过程是如何实现的？这是凭借了**协议栈**的使用。每一台电脑都需要和网络上其他电脑交流的能力，这种能力也就是协议栈通常被内建在操作系统中。网络中使用的协议栈就是指 TCP/IP 协议，它们主要作为电脑之间交流使用的协议。TCP/IP 协议看起来就像下面这样子：

<table>
  <tr>
    <th>协议层次</th>
    <th>说明</th>
  </tr>
  <tr>
    <td>应用层协议</td>
    <td>与具体的应用有关的协议，例如 WWW，e-mail，FTP 等等</td>
  </tr>
  <tr>
    <td>传输控制层协议</td>
    <td>TCP 将数据包通过一个端口号传送给具体的应用</td>
  </tr>
  <tr>
    <td>网络层协议</td>
    <td>IP 将数据包通过 IP 地址传递给具体的电脑</td>
  </tr>
  <tr>
    <td>硬件层协议</td>
    <td>将二进制数据包转换成网络信号传递后再转变回原样（比如网卡和电话线上网用的猫）</td>
  </tr>
</table>

如果我们一路跟着从我们的电脑发出的信息“Hello computer 5.6.7.8!”一直到接收方 IP 地址 5.6.7.8，那么就会发生如下流程：

<p align="center">
  <img alt="internet" src="../img/internet2.gif">
</p>

1. 一开始信息最先出现在协议栈的顶端然后一路向下走。
2. 如果需要传递的信息太长，那么每一个栈层会将传递的信息分割成小的数据块。这是因为通过网络传输的数据包需要是容易处理的。在网络中，这些数据块就是人们熟知的数据包。
3. 数据包会经过应用层然后继续经过 TCP 层。每一个数据包都会被指派一个端口号。当传输数据的时候我们需要知道哪一个目标电脑上的程序需要接收这个数据因为它会监听指定的端口号。
4. 在经过了 TCP 层后，数据包被传递给 IP 层。这个地方数据包可以确定目标地址的位置为 5.6.7.8。
5. 现在我们的数据包拥有了一个端口号和一个 IP 地址，它们已经准备好被传递了。硬件层只关心如何将数据包中的文本信息转换成电子信号然后将它们通过网线传递出去。
6. 在网线的另一头你的 ISP 和网络直接连接。ISP 路由检查每一个数据包的目标地址然后确定将数据发向哪里。通常，数据包的下一站是另外一个路由器。
7. 终于，数据包抵达了电脑 5.6.7.8。这里，数据包最开始出现在目标电脑的 TCP/IP 协议栈的最底部，它会向上走。
8. 当数据向上经过协议栈的时候，数据中由发送信息的电脑添加的，有关传输路线的数据（例如 IP 地址和端口号）都被剥除掉。
9. 当数据到达了协议栈的最顶端，数据包会被重新组装成原始格式"Hello computer 5.6.7.8!"

## 网络基础设施